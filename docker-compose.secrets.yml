version: '3.8'

# Docker Secrets Configuration (Production)
# Create secrets first:
# echo "your-token" | docker secret create ksef_token -
# echo "your-key" | docker secret create pushover_user_key -
# echo "your-token" | docker secret create pushover_api_token -
# echo "https://discord.com/api/webhooks/..." | docker secret create discord_webhook_url -
# echo "https://hooks.slack.com/services/..." | docker secret create slack_webhook_url -
# echo "your-smtp-password" | docker secret create email_password -
# echo "your-webhook-token" | docker secret create webhook_token -

secrets:
  ksef_token:
    external: true
  pushover_user_key:
    external: true
  pushover_api_token:
    external: true
  discord_webhook_url:
    external: true
  slack_webhook_url:
    external: true
  email_password:
    external: true
  webhook_token:
    external: true

services:
  ksef-monitor:
    image: ghcr.io/mlotocki2k/ksef_monitor:latest
    container_name: ksef-invoice-monitor
    restart: unless-stopped

    # Use Docker secrets (recommended for production)
    # Only mount secrets for channels you're actually using
    secrets:
      - ksef_token
      - pushover_user_key
      - pushover_api_token
      - discord_webhook_url
      - slack_webhook_url
      - email_password
      - webhook_token

    ports:
      # Prometheus metrics endpoint
      - "8000:8000"

    volumes:
      # Configuration file (non-sensitive settings only)
      - ./config.secure.json:/data/config.json:ro
      
      # Persistent storage for tracking seen invoices
      - ./data:/data
    
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # For Docker Swarm deployment
    deploy:
      replicas: 1
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
