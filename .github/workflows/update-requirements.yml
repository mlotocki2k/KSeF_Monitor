name: Update requirements.txt

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  update-requirements:
    if: github.event.label.name == 'requirements'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        branch: [test, main]

    steps:
      - name: Checkout ${{ matrix.branch }} branch
        uses: actions/checkout@v4
        with:
          ref: ${{ matrix.branch }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Parse and upgrade packages
        id: upgrade
        run: |
          set -euo pipefail

          pip install --quiet --upgrade pip

          # Extract active (non-commented) packages
          grep -v '^\s*#' requirements.txt | grep -v '^\s*$' > active_packages.txt || true

          if [ ! -s active_packages.txt ]; then
            echo "No active packages found in requirements.txt"
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Install current versions
          pip install --quiet -r active_packages.txt
          pip freeze > before_freeze.txt

          # Upgrade each package to latest
          while IFS= read -r line; do
            pkg_name=$(echo "$line" | sed 's/[>=<].*//' | xargs)
            if [ -n "$pkg_name" ]; then
              echo "Upgrading: $pkg_name"
              pip install --quiet --upgrade "$pkg_name" || echo "WARNING: Failed to upgrade $pkg_name"
            fi
          done < active_packages.txt

          pip freeze > after_freeze.txt

          # Build updated requirements.txt preserving comments and structure
          cp requirements.txt requirements.new.txt

          while IFS= read -r line; do
            pkg_name=$(echo "$line" | sed 's/[>=<].*//' | xargs)
            if [ -n "$pkg_name" ]; then
              new_version=$(grep -i "^${pkg_name}==" after_freeze.txt | head -1) || true
              if [ -n "$new_version" ]; then
                old_escaped=$(echo "$line" | sed 's/[&/\]/\\&/g')
                new_escaped=$(echo "$new_version" | sed 's/[&/\]/\\&/g')
                sed -i "s|${old_escaped}|${new_escaped}|g" requirements.new.txt
              fi
            fi
          done < active_packages.txt

          mv requirements.new.txt requirements.txt

          # Generate changelog
          echo "## Package Changes" > changelog.md
          echo "" >> changelog.md

          has_changes=false
          while IFS= read -r line; do
            pkg_name=$(echo "$line" | sed 's/[>=<].*//' | xargs)
            if [ -n "$pkg_name" ]; then
              old_ver=$(grep -i "^${pkg_name}==" before_freeze.txt | sed 's/.*==//' | head -1) || true
              new_ver=$(grep -i "^${pkg_name}==" after_freeze.txt | sed 's/.*==//' | head -1) || true
              if [ -n "$old_ver" ] && [ -n "$new_ver" ] && [ "$old_ver" != "$new_ver" ]; then
                echo "| \`$pkg_name\` | $old_ver | $new_ver |" >> changelog.md
                has_changes=true
              fi
            fi
          done < active_packages.txt

          if [ "$has_changes" = true ]; then
            sed -i '2a | Package | Old Version | New Version |\n|---|---|---|' changelog.md
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          else
            echo "No package updates available." > changelog.md
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          fi

          echo "CHANGELOG<<CHANGELOG_EOF" >> "$GITHUB_ENV"
          cat changelog.md >> "$GITHUB_ENV"
          echo "CHANGELOG_EOF" >> "$GITHUB_ENV"

      - name: Create PR branch and push
        if: steps.upgrade.outputs.has_changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          BRANCH_NAME="update-requirements-${{ matrix.branch }}"
          git checkout -b "$BRANCH_NAME"
          git add requirements.txt
          git commit -m "Update requirements.txt packages (${{ matrix.branch }})

          Automated update triggered by issue #${{ github.event.issue.number }}

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          git push origin "$BRANCH_NAME" --force

      - name: Create or update PR
        if: steps.upgrade.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ matrix.branch }}';
            const headBranch = `update-requirements-${branch}`;
            const changelog = process.env.CHANGELOG;

            const { data: existingPRs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${headBranch}`,
              base: branch,
              state: 'open'
            });

            const body = [
              `## Automated requirements.txt update (\`${branch}\`)`,
              ``,
              changelog,
              ``,
              `---`,
              `Triggered by issue #${context.issue.number}`,
              `cc @mlotocki2k`
            ].join('\n');

            let pr;
            if (existingPRs.length > 0) {
              pr = existingPRs[0];
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                body: body
              });
            } else {
              const { data: newPR } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `Update requirements.txt packages (${branch})`,
                head: headBranch,
                base: branch,
                body: body
              });
              pr = newPR;
            }

            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);

      - name: Comment on issue - changes found
        if: steps.upgrade.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ matrix.branch }}';
            const changelog = process.env.CHANGELOG;
            const prUrl = '${{ steps.create_pr.outputs.pr_url }}' || '(see PRs)';
            const prNumber = '${{ steps.create_pr.outputs.pr_number }}' || '';

            const body = [
              `### :package: Requirements Update (\`${branch}\` branch)`,
              ``,
              changelog,
              ``,
              `---`,
              ``,
              `:arrow_right: PR created for \`${branch}\`: #${prNumber}`,
              `cc @mlotocki2k`,
              ``,
              `> Triggered by issue #${context.issue.number}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });

      - name: Comment on issue - no changes
        if: steps.upgrade.outputs.has_changes == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branch = '${{ matrix.branch }}';
            const body = [
              `### :white_check_mark: Requirements Check (\`${branch}\`) - All packages are up to date`,
              ``,
              `No updates available for packages in \`requirements.txt\` on \`${branch}\`.`,
              ``,
              `cc @mlotocki2k`,
              ``,
              `> Triggered by issue #${context.issue.number}`
            ].join('\n');

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
